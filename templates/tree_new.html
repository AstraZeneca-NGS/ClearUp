{% extends "_base.html" %}

{% block head %}
        <!--suppress ALL -->
        <title>{{ title }}</title>

        <style>

        body {
          font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
          margin: 0;
        }

        .links {
          fill: none;
          stroke: #000;
        }

        .link-extensions {
          fill: none;
          stroke: #000;
          stroke-opacity: .25;
        }

        .labels {
          font: 10px sans-serif;
        }

        .link--active {
          stroke: #000 !important;
          stroke-width: 1.5px;
        }

        .link-extension--active {
          stroke-opacity: .6;
        }

        .label--active {
          font-weight: bold;
        }

        </style>

{% endblock %}

{% block body %}
        <p style="font-size: 1.5em;">
            <a href="/" style="margin-left: -1.1em;">
            < AZ projects with pre-computed fingerprints</a>
            <br><br>
            <span style="font-weight: bold;">Phylogeny tree based on fingerprints</span>
        </p>

        <ul style="margin-left: -23px;">
        <span style="margin-left: -16px;">Samples from the following projects are used:</span>
        {% for project in projects %}
            <li style="color: {{ project.color }}">{{ project.name }}</li>
        {% endfor %}
        </ul>
        <br>

        <div>
            <label id="show-length">
              <input type="checkbox" checked> Show branch length
            </label>
        </div>
        <div id="data_json" style="display: none;">{{ data|safe }}</div>
        <svg id="tree_svg"></svg>


{% endblock %}

{% block js %}
        <script src="{{ url_for('static', filename='d3/d3.v4.js') }}"></script>

        <!-- Copyright 2011 Jason Davies https://github.com/jasondavies/newick.js -->
        <script>function parseNewick(a){for(var e=[],r={},s=a.split(/\s*(;|\(|\)|,|:)\s*/),t=0;t<s.length;t++){var n=s[t];switch(n){case"(":var c={};r.branchset=[c],e.push(r),r=c;break;case",":var c={};e[e.length-1].branchset.push(c),r=c;break;case")":r=e.pop();break;case":":break;default:var h=s[t-1];")"==h||"("==h||","==h?r.name=n:":"==h&&(r.length=parseFloat(n))}}return r}</script>

        <script>

        var numSamples = {{ samples_count }};

        var minTreeWidth = 600,
            minTreeHeight = 300,
            minSvgWigth = 960,
            sampleHeight = 10,
            sampleWidth = 5;

        var treeWidth = d3.max([numSamples * sampleWidth, minTreeWidth]) / 2,
            height = d3.max([numSamples * sampleHeight, minTreeHeight]),
            svgWidth = d3.max([treeWidth * 2, minSvgWigth]),
            svgHeight = height + sampleHeight;

        var cluster = d3.cluster()
            .size([height, treeWidth])
            .separation(function(a, b) { return 1; });

        var svg = d3.select("#tree_svg")
            .attr("width", svgWidth)
            .attr("height", svgHeight);

        var offsetX = 20;
        var chart = svg.append("g")
            .attr("transform", "translate(" + offsetX + "," + svgHeight + ")rotate(-90)");

        var projects = {{ projects|safe }};
        var data = $('#data_json').text();
        $(function() {
          var root = d3.hierarchy(parseNewick(data), function(d) { return d.branchset; })
              .sum(function(d) { return d.branchset ? 0 : 1; })
              .sort(function(a, b) { return (a.value - b.value) || d3.ascending(a.data.length, b.data.length); });

          cluster(root);

          var input = d3.select("#show-length input").on("change", changed),
              timeout = setTimeout(function() { input.property("checked", true).each(changed); }, 2000);

          setRadius(root, root.data.length = 0, treeWidth / maxLength(root));
          setColor(root);

          var linkExtension = chart.append("g")
              .attr("class", "link-extensions")
            .selectAll("path")
            .data(root.links().filter(function(d) { return !d.target.children; }))
            .enter().append("path")
              .each(function(d) { d.target.linkExtensionNode = this; })
              .attr("d", linkExtensionVariable);

          var link = chart.append("g")
              .attr("class", "links")
            .selectAll("path")
            .data(root.links())
            .enter().append("path")
              .each(function(d) { d.target.linkNode = this; })
              .attr("d", linkVariable)
              .attr("stroke", function(d) { return d.target.color; });

          var labelSpacing = 5;
          chart.append("g")
              .attr("class", "labels")
            .selectAll("text")
            .data(root.leaves())
            .enter().append("a")
              .attr("xlink:href", function(d) { return getSampleId(d.data.name); })
              .attr("pointer", "cursor")
              .append("text")
              .attr("transform", function(d) {
                return "translate(" + d.x + "," + (labelSpacing + treeWidth) + ")rotate(90)";
              })
              .attr("text-anchor", "start")
              .text(function(d) { return d.data.name.replace(/_/g, " "); })
              .style("fill", function(d) {
                  return setColor(d);
              })
              .on("mouseover", mouseovered(true))
              .on("mouseout", mouseovered(false));

          function changed() {
            clearTimeout(timeout);
            var t = d3.transition().duration(750);
            linkExtension.transition(t).attr("d", this.checked ? linkExtensionVariable : linkExtensionConstant);
            link.transition(t).attr("d", this.checked ? linkVariable : linkConstant);
          }

          function mouseovered(active) {
            return function(d) {
              d3.select(this).classed("label--active", active);
              d3.select(d.linkExtensionNode).classed("link-extension--active", active).each(moveToFront);
              do d3.select(d.linkNode).classed("link--active", active).each(moveToFront); while (d = d.parent);
            };
          }

          function moveToFront() {
            this.parentNode.appendChild(this);
          }
        });

        // Compute the maximum cumulative length of any node in the tree.
        function maxLength(d) {
          return d.data.length + (d.children ? d3.max(d.children, maxLength) : 0);
        }

        // Set the radius of each node by recursively summing and scaling the distance from the root.
        function setRadius(d, y0, k) {
            if (!d.parent) d.radius = 0;
            else d.radius = (y0 += d.data.length) * k;
            if (d.children) d.children.forEach(function(d) { setRadius(d, y0, k); });
        }

        // Set the color of each node by recursively inheriting.
        function setColor(d) {
            var name = d.data.name;
            if (!name && d.children) {
                var colors = [];
                $.each(d.children, function(i, node){
                    color = setColor(node)
                    if($.inArray(color, colors) === -1) colors.push(color);
                });
                if (colors.length == 1) d.color = colors[0];
                else d.color = '#ccc';
            }
            else if (name) {
                project = getSampleProject(name);
                d.color = project.color;
            }
            return d.color;
        }

        function splitSampleName(name) {
            return name.split('____PROJECT_');
        }

        function getSampleId(name) {
            project = getSampleProject(name);
            return project.ids[project.samples.indexOf(splitSampleName(name)[0])];
        }

        function getSampleProject(name) {
            name = splitSampleName(name);
            var sampleName = name[0],
                projectName = name.length > 1 ? name[1] : null;
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].samples.indexOf(sampleName) != -1 && (!projectName || projects[i].name == projectName)) {
                    return projects[i];
                }
            }
        }

        function linkVariable(d) {
          return linkStep(d.source.x, d.source.radius, d.target.x, d.target.radius);
        }

        function linkConstant(d) {
          return linkStep(d.source.x, d.source.y, d.target.x, d.target.y);
        }

        function linkExtensionVariable(d) {
          return linkStep(d.target.x, d.target.radius, d.target.x, treeWidth);
        }

        function linkExtensionConstant(d) {
          return linkStep(d.target.x, d.target.y, d.target.x, treeWidth);
        }

        function linkStep(sourceX, sourceY, targetX, targetY) {
          return "M" + sourceX + "," + sourceY + "A 0,0 0 0,0 " + targetX + "," + sourceY + "L" + targetX + "," + targetY;
        }

        </script>
{% endblock %}



